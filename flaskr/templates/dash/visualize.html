{% extends 'base.html' %}

{% block header %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualize Study Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Include Plotly.js for the pie chart -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include Chart.js for the time graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
{% endblock %}

{% block content %}
<body class="background">
    <div class="center-container">
        <!-- Pie Chart Slot -->
        <h2>Pie Chart</h2>
        <div class="div" id="pie-chart" style="width:750px;height:500px;">
            <div id="pie-chart-data"></div> <!-- Placeholder for the pie chart -->
        </div>




        <!-- Time Graph Slot -->
        <h2>Time Graph</h2>
          <!-- User input for ranges-->
        <div class="slot" id="time-graph">
        </div>
        <div> 
            <form id="log-hours-form" method="post" action="">
                <label for="hours">Range Low</label>
                <input type="range" id="low" name="low" min="0" max="52">

                <label for="high">Range High</label>
                <input type="range" id="high" name="high" min="0" max="52">
            </form>
         </div>

    </div>

    <footer>
        <!-- Add footer content here if needed -->
    </footer>
    
    <!-- Embed the study_data as JSON in the HTML -->
     <!--  Script for pie chart-->
    <script>
        // Convert the passed study_data dictionary into a JavaScript object 
        // so that the Js on the server can actually render this python dictionary, Jinja expression
        const studyData = {{study_data | tojson}};
        
         //<Prepare the data for the pie chart & graph
        const values = studyData['hours_data'];  // Extract hours data
        const labels = studyData['classes_data'];  // Extract course names
        const weeklyHours = studyData['study_hours_data']; // Extract all weekly hours keyed to a course names

        //Section - Define the colors for each course

        function getRandomHexColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }

            return color;
        }

        // Assign each course to a color
        const courseColors = {}; // Define dict to hold data for course and corresponding colors
        for (let i = 0; i < labels.length; i++){
            const tempName = labels[i];
            console.log(tempName)
            courseColors[tempName] = {};  // Create a nested object for each course name
            //courseColors[tempName]['name'] = tempName; // Set the name for the line
            courseColors[tempName]['colors'] = getRandomHexColor(); // Set a random color for the course
        }

        // Pie Chart section
        var data = [{
            values: values,
            labels: labels,
            type: 'pie'  // Pie chart type
        }];

        var layout = {
            title: 'Study Hours per Course'
        };
        // Create pie chart using the div, data taken from json, and layout
        Plotly.newPlot('pie-chart', data, layout);

        //----------------------------------------------------------------------
        const numLines = labels.length; // get length for, for loop, lables contains course names
        const allCourseLines = []; // Store all course lines in this array to pass to Plotly.newPlot() as the data parameter

        for (let i = 0; i < numLines; i++) {
            const CourseLine = {}; // Dict for each course storing needed date and time keys for a line
            const dateList = []; // Array for dates
            const hours = []; // Array for course hours

            const courseName = labels[i]; // Get the current course name from the labels array
            const courseData = weeklyHours[courseName]; // Get the weekly data for this course

            // Loop through each entry for the current course
            const date = courseData.map(entry => entry.week);
            const time = courseData.map(entry => entry.weekly_hours);

            dateList.push(...date); // Append the date values for this course
            hours.push(...time); // Append the time (weekly_hours) values for this course

            CourseLine['x'] = dateList; // x-axis data (weeks)
            CourseLine['y'] = hours; // y-axis data (hours studied)
            CourseLine['type'] = 'scatter'; // Line type for Plotly graph
            CourseLine['name'] = courseName; // Set the name for the line
            CourseLine['line'] = {color: courseColors[courseName]['colors']}

            allCourseLines.push(CourseLine); // Push the course line data to the allCourseLines array
        }

        // Add submission to catch the value of ranges the user wants

        // Graph design i.e axis titles
        var layoutGraph = {    

                    title: {
                        text: 'Timeline of Weekly Study Hours'
                    },

                    xaxis: {
                        title: {
                            text: 'Weeks'
                        },
                        range: [ 1, 52 ]
                    },

                    yaxis: {
                        title: {
                            text: 'Hours'
                        }
                    }

        };


        // Now pass allCourseLines to Plotly.newPlot() as the data parameter
        Plotly.newPlot('time-graph', allCourseLines, layoutGraph);




    </script>


   

</body>
{% endblock %}
